(function(){"use strict";function x(n,c,r=128){const e=c;let s,t,f,l;const i=n.length;for(let u=0;u<i;u++){s=[u+1,u+2,u+e-1,u+e,u+e+1,u+2*e],t=n[u]<r?0:255,f=n[u]-t,n[u]=t;for(let o=0;o<s.length;o++)l=s[o],n[l]+=f/8>>0}}function C(n,c,r,e=128){const s=[[96,40,48,104,140,188,196,148],[32,0,8,56,180,236,244,204],[88,24,16,64,172,228,252,212],[120,80,72,112,132,164,220,156],[136,184,192,144,100,44,52,108],[176,232,240,200,36,4,12,60],[168,224,248,208,92,28,20,68],[128,160,216,152,124,84,76,116]];let t,f,l;for(f=0;f<r;f++)for(l=0;l<c;l++){t=f*c+l;const i=n[t]+s[f&7][l&7]>>1>>0;n[t]=i<e?0:255}}function L(n,c,r=180,e=0){const s=c;let t,f,l,i;const u=[7,3,5,1],o=n.length,a=16+e;for(let y=0;y<o;y++){t=[y+1,y+s-1,y+s,y+s+1],f=n[y]<r?0:255,l=n[y]-f,n[y]=f;for(let p=0;p<t.length;p++)i=t[p],n[i]=n[i]+l*u[p]/a}}function g(n,c,r=255){const e=c;let s,t,f,l;const i=[7,5,3,5,7,5,3,1,3,5,3,1],u=n.length;for(let o=0;o<u;o++){s=[o+1,o+2,o+e-2,o+e-1,o+e,o+e+1,o+e+2,o+e*2-2,o+e*2-1,o+e*2,o+e*2+1,o+e*2+2],t=n[o]<r?0:255,f=n[o]-t,n[o]=t;for(let a=0;a<s.length;a++)l=s[a],n[l]+=f*i[a]/48}}function I(n,c,r=128){const e=c;let s,t,f,l;const i=[5,3,2,4,5,4,2,2,3,2],u=n.length;for(let o=0;o<u;o++){s=[o+1,o+2,o+e-2,o+e-1,o+e,o+e+1,o+e+2,o+e*2-1,o+e*2,o+e*2+1],t=n[o]<r?0:255,f=n[o]-t,n[o]=t;for(let a=0;a<s.length;a++)l=s[a],n[l]+=f*i[a]/32>>0}}function P(n,c,r=128){const e=c;let s,t,f,l;const i=[8,4,2,4,8,4,2,1,2,4,2,1],u=n.length;for(let o=0;o<u;o++){s=[o+1,o+2,o+e-2,o+e-1,o+e,o+e+1,o+e+2,o+e*2-2,o+e*2-1,o+e*2,o+e*2+1,o+e*2+2],t=n[o]<r?0:255,f=n[o]-t,n[o]=t;for(let a=0;a<s.length;a++)l=s[a],n[l]+=f*i[a]/42>>0}}function k(n,c=!1){const r=n.length/4,e=new Uint8ClampedArray(r),s=c?new Uint8ClampedArray(r):void 0;for(let t=0;t<n.length;t+=4){const f=n[t],l=n[t+1],i=n[t+2],u=n[t+3],o=U({R:f,G:l,B:i,A:u});e[t>>2]=z(o.R,o.G,o.B),c&&s&&(s[t>>2]=u)}return{colorArray:e,alphaArray:s}}function U(n,c={R:255,G:255,B:255}){const r=n.A/255;return{R:(1-r)*c.R+r*n.R,G:(1-r)*c.G+r*n.G,B:(1-r)*c.B+r*n.B}}function z(n,c,r){return .3*n+.6*c+.1*r>>0}function _(n,c,r,e,s,t){const f=s*t,l=new Uint8ClampedArray(f),i=c!==void 0,u=r/s,o=e/t,a=new Uint8ClampedArray(f);for(let y=0;y<t;y++)for(let p=0;p<s;p++){const A=p*u>>0,R=y*o>>0,h=R*r+A,j=p*u-A,G=y*o-R,b=n[h],T=A===r-1?b:n[h+1],V=R===e-1?b:n[h+r],q=R===e-1||A===r-1?b:n[h+r+1],E=b*(1-j)*(1-G)+T*j*(1-G)+V*G*(1-j)+q*j*G;if(i){const v=c[h],O=A===r-1?v:c[h+1],Q=R===e-1?v:c[h+r],X=R===e-1||A===r-1?v:c[h+r+1],Y=v*(1-j)*(1-G)+O*j*(1-G)+Q*G*(1-j)+X*j*G,Z=y*s+p;a[Z]=Y}const K=E>>0,N=y*s+p;l[N]=K}return i?{colorData:l,alphaData:a}:{colorData:l}}var w=(n=>(n.Grayscale="grayscale",n.Bayer="Bayer",n.Stucki="Stucki",n.Atkinson="Atkinson",n.Jarvis="Jarvis",n.Sierra="Sierra",n.Floyd="Floyd",n))(w||{});function d(n,c,r,e,s){switch(n){case"Atkinson":return x(c,r,s);case"Bayer":return C(c,r,e,s);case"Jarvis":return g(c,r,s);case"Sierra":return I(c,r,s);case"Stucki":return P(c,r,s);case"Floyd":return L(c,r,s);default:return k(c)}}class B{constructor(c){c&&this.setup(c),self.onerror=(r,e,s,t,f)=>{const l={source:e,lineno:s,colno:t,error:f};console.error(["=> worker process error",l]),this.send({type:"error",data:l})}}setup(c){self.onmessage=r=>{const{type:e}=r.data,s=c[e];if(typeof s=="function"){const t=s(r.data);t instanceof Promise&&t.catch(f=>{console.error(["=> worker process error",f]),this.send({type:"error",data:f})})}}}send(c){self.postMessage(c)}}function F(n,c,r,e){const s=n.length*4,t=new Uint8ClampedArray(s),f=c!==void 0;for(let l=0;l<n.length;l++){const i=l*4;t[i]=n[l],t[i+1]=n[l],t[i+2]=n[l],t[i+3]=f?c[l]:255}return new ImageData(t,r,e)}const J={async imageProcess(n){console.time("2. imageProcess");const{type:c,reqId:r,data:e}=n,{bitmapMode:s=w.Grayscale,oWidth:t,oHeight:f,destWidth:l,destHeight:i,keepAlpha:u=!1}=e,{source:o}=e;let{colorArray:a,alphaArray:y}=k(o,u);if(t!==l||f!==i){const A=_(a,y,t,f,l,i);a=A.colorData,A.alphaData&&(y=A.alphaData)}s.toLowerCase()!==w.Grayscale&&d(s,a,l,i,127);const p=F(a,y,l,i);console.timeEnd("2. imageProcess"),S.send({type:c,reqId:r,data:p})}},S=new B;S.setup(J)})();
