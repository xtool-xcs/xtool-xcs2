var $=Object.defineProperty;var j=(s,e,i)=>e in s?$(s,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[e]=i;var T=(s,e,i)=>(j(s,typeof e!="symbol"?e+"":e,i),i);import{useExtCenterStore as q,apiParserNext as g,isError as A,ProductType as r,BaseViewModel as z,sensorsTrack as I,ButtonNames as W,EventNames as S,defineStore as J,useViewModel as K,checkIsIphone$1 as y,observeState as k,__unplugin_components_0 as Q,_export_sfc as X}from"./main-f7BGirYr.js";import{defineComponent as Y,ref as u,onMounted as Z,onBeforeUnmount as ee,openBlock as m,createElementBlock as _,withDirectives as ie,vShow as te,createBaseVNode as l,createVNode as ne,toDisplayString as p,unref as f,createBlock as x,createCommentVNode as w}from"./importmap-vue-u6Q_1Jji.js";import{useI18n as se}from"./importmap-vue-i18n-LlhaB8iP.js";import"../assets/index-FfF0Lcw0.js";import{PERMISSION_STATUS as M}from"./apconnectconfig-XbZ4D7sa.js";import{useRouter as oe}from"./importmap-vue-router-aHGpzyJi.js";import{showConfirmDialog as B}from"./importmap-vant-Ij4SMMwJ.js";class ae{getExt(){return q().ext}}const C=new ae,v=[{name:"configWifi",url:"/net",type:"post",params:{action:"connsta"},headers:{"Content-Type":"text/plain;charset=UTF-8"}},{name:"setWifi",url:"/net/set_wifi",method:"post"},{name:"setWifiS1New",url:"/net/setWifi",method:"post"}];class re{constructor(){T(this,"deviceIp","192.168.40.1")}async configWifiToS1(e,i){const t=g(v,this.deviceIp);try{const n={username:e,passwd:i},o=await t.setWifiS1New({data:n});return!A(o)}catch(n){return console.error(n),!1}}async configWifiToM1(e,i){const t=g(v,this.deviceIp);try{const n=`"${e}" "${i}"`;return await t.configWifi({data:n}),!0}catch(n){return console.error(n),!0}}async configWifiToNew(e,i){const t=g(v,this.deviceIp);try{const n={username:e,passwd:i},o=await t.setWifi({data:n});return!A(o)}catch(n){return console.error(n),!1}}async configWifiToOther(e,i){const t=g(v,this.deviceIp);try{const n=`${e} ${i}`;return(await t.configWifi({data:n})).result==="ok"}catch(n){return console.error(n),!1}}async setWifiInfoByExtId(e,i,t){return t===r.S1?await d.configWifiToS1(e,i):t===r.M1?await d.configWifiToM1(e,i):[r.P2,r.F1].includes(t)?await d.configWifiToNew(e,i):await d.configWifiToOther(e,i)}}const d=new re,ce={[r.F1Ultra]:"xTool_F1 Ultra",[r.S1]:"xTool_S1",[r.F1]:"xTool_F1",[r.P2]:"xTool_P2",[r.D1Pro2]:"xTool_D1P",[r.D1Pro]:"xTool_D1P",[r.D1]:"xTool_D1",[r.M1]:"xTool_M1",[r.M2]:"xTool_M2"},le=(s,e)=>{const i=ce[s];return i.split("_")[0]===e.split("_")[0]&&i.split("_")[1]===e.split("_")[1]};class me{constructor(e,i,t){this.wifiName=e,this.wifiPwd=i,this.extId=t}}class pe{}class D{}class b{}class O{constructor(e){this.isIPhone=e}}class V{constructor(e){this.isIPhone=e}}class fe{}class de extends z{createState(){return{currentWifiName:"",hasPermission:!1,wifiName:"",isGrantedInputWifiPermission:!1,isOpenGpsPermission:!1,isOpenLocationPermission:!1,isOpenAccuratePermission:!1}}setEventHandler(){this.registerEventHandler(me,this.handleConfigWifiEvent),this.registerEventHandler(pe,this.grantedPadInputWifiPermissions),this.registerEventHandler(D,this.grantedPhoneLocationPermission),this.registerEventHandler(b,this.grantedPhoneGPSPermission),this.registerEventHandler(O,this.grantedPhoneAccuracyLocationPermission),this.registerEventHandler(V,this.grantedPhoneInputWifiPermissions),this.registerEventHandler(fe,this.getWifiName)}async handleConfigWifiEvent(e){var o;console.log("===>handleConfigWifiEvent",C.getExt());let i="";if(e.extId)i=e.extId;else if(C.getExt())i=(o=C.getExt())==null?void 0:o.id;else return console.error(`===>handleConfigWifiEvent 当前连接的extId不合法 extId: ${e.extId}`),!1;const t=await window.MeApi.wifi.getWifiName();console.log("===>handleConfigWifiEvent wifiName",t);const n=le(i,t??"");return Object.values(r).includes(i)&&n?await d.setWifiInfoByExtId(e.wifiName,e.wifiPwd,i):!1}async grantedPadInputWifiPermissions(){const e=window.MeApi.permission;let i=!1;if(i=await e.isGrantedLocationPermission(),i?this.updateState({isGrantedInputWifiPermission:!0}):this.updateState({isGrantedInputWifiPermission:!1}),!i){const t=await e.grantLocationPermission();return console.log("==>ap grantedWifiPermissions location ",t),t}}async grantedPhoneLocationPermission(){I(S.buttonClick,{elementId:W.locationAccess});const e=window.MeApi.permission,i=await e.isGrantedLocationPermission();this.updateState({isOpenLocationPermission:i}),console.log("==>PermissionsCheck grantedPhoneLocationPermission",i),i||await e.grantLocationPermission()||e.openAppPermissionPage()}async grantedPhoneGPSPermission(){I(S.buttonClick,{elementId:W.gps});const e=window.MeApi.permission,i=await e.isLocationOpen();this.updateState({isOpenGpsPermission:i}),console.log("==>PermissionsCheck grantedPhoneGPSPermission",i),i||await e.openLocationPage()}async grantedPhoneAccuracyLocationPermission(e){I(S.buttonClick,{elementId:W.precisePositioning});const i=window.MeApi.permission;let t=!1;e.isIPhone?t=await i.isAccuracyLocationOpen():t=!0,this.updateState({isOpenAccuratePermission:t}),console.log("==>PermissionsCheck grantedPhoneAccuracyLocationPermission",t),t||await i.openLocationPage()}async grantedPhoneInputWifiPermissions(e){const i=window.MeApi.permission,t=await i.isLocationOpen(),n=await i.isGrantedLocationPermission();let o=!1;return e.isIPhone?o=await i.isAccuracyLocationOpen():o=!0,this.updateState({isOpenLocationPermission:n}),this.updateState({isOpenGpsPermission:t}),this.updateState({isOpenAccuratePermission:o}),t&&n&&o?(this.updateState({isGrantedInputWifiPermission:!0}),console.log("==>PermissionsCheck grantedPhoneInputWifiPermissions",!0),!0):(this.updateState({isGrantedInputWifiPermission:!1}),!1)}async getWifiName(){console.log("==>getWifiName ",this.uiState.isGrantedInputWifiPermission);const e=await window.MeApi.wifi.getWifiName();if(console.log("getWifiName wifiName",e),e){this.updateState({wifiName:e});return}this.updateState({wifiName:""})}}J("user_wifi_config_module",{getters:{},actions:{async setWifiInfoByExtId(s,e,i){return await d.setWifiInfoByExtId(s,e,i)}}});const ue={class:"permission-wrap"},he={class:"permission-card"},Pe={class:"permission-tip"},ge={class:"permission-list-btn"},_e={class:"text-btn"},we={class:"text-btn"},ve={class:"text-btn"},Ie={class:"hand-wrap"},We={key:0},Se={class:"hand-wifi-tip"},Ee={key:1},ye=Y({__name:"PermissionCheck",props:{modelValue:Number,isShowConfigWifi:Boolean},emits:["update:modelValue"],setup(s,{emit:e}){const i=e,t=K(de),n=u(!0),o=u(t.uiState.isOpenGpsPermission);console.log("==>Permis isOpenGpsPermission start",t.uiState.isOpenGpsPermission);const h=u(t.uiState.isOpenLocationPermission),E=u(t.uiState.isOpenAccuratePermission),G=u(!1);let L;const{t:a}=se();Z(()=>{console.log("==>PermissionsCheck onMounted"),L=setInterval(()=>{N()},1e3),N()});const N=async()=>{const c=await y();G.value=c,await t.sendEvent(new V(c)),t.uiState.isGrantedInputWifiPermission?i("update:modelValue",M.PERMISSION_GRANTED):n.value=!0};ee(()=>{console.log("==>PermissionsCheck onBeforeUnmount"),clearInterval(L)});const H=()=>{I(S.buttonClick,{elementId:W.supportDevice}),i("update:modelValue",M.PERMISSION_MANUAL_INPUT)},R=async()=>{o.value||(await y()?B({title:a("mobile.common.notice"),message:a("mobile.connect.go_to_setting_tip"),confirmButtonText:a("mobile.common.go_to_setting"),cancelButtonText:a("mobile.common.back")}).then(()=>{t.sendEvent(new b)}):t.sendEvent(new b))},U=async()=>{h.value||t.sendEvent(new D)},F=async()=>{if(!E.value){const c=await y();c?B({title:a("mobile.common.accurate_location_title"),message:a("mobile.common.accurate_location_tip"),confirmButtonText:a("mobile.common.go_to_setting"),cancelButtonText:a("mobile.common.back")}).then(()=>{t.sendEvent(new O(c))}):t.sendEvent(new O(c))}};return k(()=>t.uiState.isOpenLocationPermission,c=>{h.value=c}),k(()=>t.uiState.isOpenGpsPermission,c=>{o.value=c}),k(()=>t.uiState.isOpenAccuratePermission,c=>{E.value=c}),oe(),(c,ke)=>{const P=Q;return m(),_("div",ue,[ie(l("div",null,[l("div",he,[ne(P,{name:"connect-position",class:"permission-loca"}),l("div",Pe,p(f(a)("mobile.connect.permission_gps_title")),1),l("div",ge,[l("div",{class:"vanbtn",onClick:R},[o.value?(m(),x(P,{key:0,name:"address-checkmark",class:"f-s-18 com-btn-icon"})):w("",!0),l("div",_e,p(f(a)("mobile.connect.permission_gps_on")),1)]),l("div",{class:"vanbtn",onClick:U},[h.value?(m(),x(P,{key:0,name:"address-checkmark",class:"f-s-18 com-btn-icon"})):w("",!0),l("div",we,p(f(a)("mobile.connect.permission_gps_info")),1)]),G.value&&h.value?(m(),_("div",{key:0,class:"vanbtn",onClick:F},[E.value?(m(),x(P,{key:0,name:"address-checkmark",class:"f-s-18 com-btn-icon"})):w("",!0),l("div",ve,p(f(a)("mobile.common.accurate_permission_on")),1)])):w("",!0)])]),l("div",Ie,[s.isShowConfigWifi?(m(),_("div",Ee)):(m(),_("div",We,[l("div",Se,p(f(a)("mobile.connect.permission_gps_off")),1),l("a",{class:"hand-input-btn",onClick:H},p(f(a)("mobile.connect.hand_input_wifi")),1)]))])],512),[[te,n.value]])])}}}),Ae=X(ye,[["__scopeId","data-v-2ccb15b4"]]);export{me as ConfigWifiEvent,fe as GetWifiNameEvent,V as GrantedPhoneInputWifiPermissionsEvent,Ae as PermissionCheck,de as WifiConfigViewModel};
