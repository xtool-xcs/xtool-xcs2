import{BaseViewModel as X,materialManager as Y,observeState as L,projectManager as w,isEmpty as q,useViewModel as H,useDataSource as J,useCanvasStore as A,useExtCenterStore as ue,storeToRefs as G,useSettingStore as ve,useSystemBack as Q,__unplugin_components_0 as de,_export_sfc as N,observeEffect as V,endsWith as K,DEFAULT_IMPORT_DISPLAY_X as pe,DEFAULT_IMPORT_DISPLAY_Y as me,calcAspectRatioFit as he}from"./main-f7BGirYr.js";import{useRouter as R,onBeforeRouteLeave as fe}from"./importmap-vue-router-aHGpzyJi.js";import{EdSettingViewModel as Z,ChangeCanvasDataEvent as _e,EdSettingImportEvent as ge}from"./index-roID5kc2.js";import"../assets/index-FfF0Lcw0.js";import{useI18n as O}from"./importmap-vue-i18n-LlhaB8iP.js";import{defineComponent as B,ref as _,computed as T,onMounted as F,openBlock as P,createElementBlock as $,createVNode as u,unref as r,withCtx as g,watch as we,createBlock as I,createBaseVNode as S,toDisplayString as ee,resolveDynamicComponent as Se,withKeys as Ee,resolveComponent as Pe,createTextVNode as Me,pushScopeId as be,popScopeId as xe}from"./importmap-vue-u6Q_1Jji.js";import{Cell as te,Picker as ye,Popup as Ce,Space as ne,NavBar as ke,Dialog as je,showConfirmDialog as Ie,Icon as He,Popover as Le,Field as Ve,Button as Te}from"./importmap-vant-Ij4SMMwJ.js";import{MoreMaterial as Be}from"./morematerial-QfHZr2Dl.js";import"./griditem.vue_vue_type_style_index_0_scoped_39934db8_lang-w40geAFS.js";import"./grid-aKCJR2-u.js";class ae{constructor(e){this.project=e}}class D{constructor(e){this.saveAs=e}}class oe{}class se{constructor(e){this.name=e}}class De{constructor(e){this.showMoreMaterial=e}}class Ae{constructor(e){this.showParameterPanel=e}}class Ne{constructor(e){this.processingTypes=e}}class Re{constructor(e){this.selectOnlineMaterialHandler=e}}class Oe extends X{createState(){return{showLoading:!1,showMoreMaterial:!1,showParameterPanel:!1,formValues:{search:"",categoryId:0,isSupport:!0},localMaterial:Y.localMaterial,pagination:{current:1,pageSize:15,total:0},onlineMaterials:[],categoryList:[],processingTypes:[]}}setEventHandler(){this.registerEventHandler(De,this.handleShowMoreMaterialEvent),this.registerEventHandler(Ne,this.handleProcessingTypesEvent),this.registerEventHandler(Re,this.handleSelectOnlineMaterialEvent),this.registerEventHandler(Ae,this.handleShowParameterPanelEvent)}handleShowMoreMaterialEvent(e){this.updateState({showMoreMaterial:e.showMoreMaterial})}handleShowParameterPanelEvent(e){this.updateState({showParameterPanel:e.showParameterPanel})}handleProcessingTypesEvent(e){this.updateState({processingTypes:e.processingTypes})}handleSelectOnlineMaterialEvent(e){Y.selectOnlineMaterialHandler=e.selectOnlineMaterialHandler}}class ce extends X{constructor(){super(),L(()=>w.currentFileName.value,e=>{this.updateState({projectName:e})}),w.hasProject=!0}createState(){return{showLoading:!1,projectName:w.currentFileName.value}}setEventHandler(){this.registerEventHandler(ae,this.openProjectEvent),this.registerEventHandler(D,this.saveProjectEvent),this.registerEventHandler(oe,this.goBackEvent),this.registerEventHandler(se,this.renameProjectEvent)}async openProjectEvent(e){this.updateState({showOpenLoading:!0});const{project:n}=e,{filePath:s,fileId:h,fileName:p,instanceId:v}=n;q(s)?await w.openProject({isNewProject:!0,file:"",instanceId:v}):await w.openProject({file:s,fileId:h,fileName:p,instanceId:v}),this.updateState({showOpenLoading:!1})}async saveProjectEvent(e){this.updateState({showLoading:!0});const{saveAs:n}=e,{result:s}=await w.saveProject(n);this.updateState({showLoading:!1}),this.sendEffect({saveProjectResult:{isSuccess:s}})}async goBackEvent(){const e=await w.isHaveChangeProject();this.sendEffect({projectHaveChange:{isHaveChange:e}})}async renameProjectEvent(e){try{this.updateState({showLoading:!0});const n=await w.renameCurrentProject(e.name);this.updateState({showLoading:!1,projectName:e.name}),this.sendEffect({renameProjectResult:{isSuccess:n}})}catch(n){console.log("renameProjectEvent error ====>",n),this.sendEffect({renameProjectResult:{isSuccess:!1}})}}onDestroy(){super.onDestroy(),w.hasProject=!1}}const Fe=B({__name:"MultiCanvas",setup(i){const{t:e}=O(),n=_([]),s=_(!1),h=H(Z),{updateCanvasId:p}=J(),v=A().cvnMsgList(),M=T(()=>v.map(a=>({value:a.id,text:a.title.replace("{panel}",e("canvas.panel"))}))),c=(a,o)=>{var E;return(E=a.filter(x=>x.id===o)[0])==null?void 0:E.title.replace("{panel}",e("canvas.panel"))},t=_("2"),l=c(v,t.value),d=_(e(l??""));L(()=>h.uiState.currentId,a=>{t.value=a,n.value[0]=a;const o=c(v,t.value);d.value=e(o??"")}),F(()=>{n.value[0]=t.value});const f=()=>{n.value[0]=t.value,s.value=!0},m=async({selectedOptions:a})=>{console.log("[选择画布]=>",a),s.value=!1;const o=a[0].value;n.value[0]!==o&&(d.value=a[0].text,n.value[0]=o,h.sendEvent(new _e(o)),p(o))},b=()=>{s.value=!1};return(a,o)=>{const E=te,x=ye,k=Ce;return P(),$("div",null,[u(E,{"is-link":"",title:r(e)("canvas.panel"),value:d.value,onClick:f},null,8,["title","value"]),u(k,{show:s.value,"onUpdate:show":o[0]||(o[0]=j=>s.value=j),position:"bottom",round:"","close-on-click-overlay":!0,"safe-area-inset-bottom":""},{default:g(()=>[u(x,{"model-value":n.value,title:r(e)("canvas.panel"),columns:M.value,"confirm-button-text":r(e)("common.msg.ok"),"cancel-button-text":r(e)("common.msg.cancel"),onCancel:b,onConfirm:m},null,8,["model-value","title","columns","confirm-button-text","cancel-button-text"])]),_:1},8,["show"])])}}}),$e={class:"device-info-cell"},Ue={class:"device-info"},ze={class:"device-info-title"},We=B({__name:"SettingContent",setup(i){const{t:e}=O(),n=R(),{updateCanvasId:s,deviceValues:h,deviceDataHandler:p}=J(),v=_(!1),M=H(Oe);L(()=>M.uiState.showMoreMaterial,y=>{v.value=y});const c=ue(),{ext:t,info:l,isInProcessing:d,isFrameMode:f,connected:m}=G(c),b=ve(),{unit:a}=G(b),o=T(()=>A().canvasId),E=T(()=>t.value&&!q(o.value)?t.value.uiApp.ProcessingModeForm:""),x=()=>{m.value?n.push("/device-setting?redirect=editor-setting"):n.push("/connect-device?redirect=editor-setting")};we([()=>o.value,()=>{var y;return(y=t.value)==null?void 0:y.dataSource}],async()=>{s(o.value)},{immediate:!0});const k=()=>{},j=()=>{};return Q(()=>(n.back(),!0)),F(()=>{}),(y,C)=>{const U=de,le=te,ie=ne;return P(),I(ie,{direction:"vertical",fill:"",size:8},{default:g(()=>{var z,W;return[S("section",$e,[u(le,{center:"","is-link":"",value:(z=r(t))==null?void 0:z.deviceInfo.name,onClick:x},{title:g(()=>[S("div",Ue,[S("span",ze,ee(r(e)("mobile.device.connect_device")),1),r(m)?(P(),I(U,{key:0,size:"20",class:"f-s-20",name:"connected",color:"#28BE44"})):(P(),I(U,{key:1,size:"20",class:"f-s-20",name:"un-connected",color:"#747a7a"}))])]),_:1},8,["value"])]),S("section",null,[(P(),I(Fe,{key:o.value})),(P(),I(Se(E.value),{key:`${(W=r(t))==null?void 0:W.id}-${o.value}`,ext:r(t),"canvas-id":o.value,"device-info":r(l),"device-values":r(h),"is-in-processing":r(d),"is-frame-mode":r(f),"dis-connect":r(m),unit:r(a),handler:r(p),onPushMessage:k,onExtendCalibrationModal:j},null,40,["ext","canvas-id","device-info","device-values","is-in-processing","is-frame-mode","dis-connect","unit","handler"])),u(r(Be),{show:v.value},null,8,["show"])])]}),_:1})}}}),Ye=N(We,[["__scopeId","data-v-525292fb"]]),Ge=B({__name:"SettingHeader",setup(i){const e=H(ce),n=R(),{t:s}=O(),h=()=>{e.sendEvent(new oe)};V(()=>e.uiEffect.projectHaveChange,a=>{a.isHaveChange?Ie({message:s("mobile.common.save_notice_title"),confirmButtonText:s("mobile.common.yes"),cancelButtonText:s("mobile.common.no"),closeOnClickOverlay:!0}).then(()=>{e.sendEvent(new D(!1))}).catch(()=>{n.back()}):n.back()}),V(()=>e.uiEffect.saveProjectResult,a=>{n.back(),a.isSuccess?console.log("=======[保存成功]"):console.log("=======[保存失败]")}),L(()=>e.uiState.showLoading,a=>{console.log("=======loading",a),console.log(a?"=======[显示加载中]":"=======[加载完成]")});const p=_(!1),v=[{value:"save",text:s("common.menu.file_save")},{value:"saveAs",text:s("common.menu.file_save_as")}],M=({value:a})=>{const o=a==="saveAs";e.sendEvent(new D(o))},c=T(()=>e.uiState.projectName),t=_(!1),l=_("Untitled"),d=a=>a.replace(/\u2006/g," "),f=()=>{t.value=!0},m=()=>{e.sendEvent(new se(l.value)),t.value=!1},b=()=>{t.value=!1};return(a,o)=>{const E=He,x=Le,k=ke,j=Ve,y=je;return P(),$("div",null,[u(k,{fixed:"","left-arrow":"",placeholder:"",onClickLeft:h},{title:g(()=>[S("div",{class:"project—name-ellipsis",onDblclick:f},ee(c.value),33)]),right:g(()=>[u(x,{show:p.value,"onUpdate:show":o[0]||(o[0]=C=>p.value=C),actions:v,placement:"bottom-end",onSelect:M},{reference:g(()=>[u(E,{size:"24",name:"ellipsis"})]),_:1},8,["show"])]),_:1}),u(y,{show:t.value,"onUpdate:show":o[2]||(o[2]=C=>t.value=C),title:"项目重命名","show-cancel-button":"","show-confirm-button":"","confirm-button-disabled":!l.value,"confirm-button-text":r(s)("common.msg.ok"),"cancel-button-text":r(s)("common.msg.cancel"),onConfirm:m,onCancel:b},{default:g(()=>[u(j,{ref:"autoFocus",modelValue:l.value,"onUpdate:modelValue":o[1]||(o[1]=C=>l.value=C),modelModifiers:{trim:!0},maxlength:15,class:"save-as-name",clearable:"",placeholder:r(s)("mobile.device.input_file_name"),formatter:d,onKeyup:Ee(m,["enter"])},null,8,["modelValue","placeholder"])]),_:1},8,["show","confirm-button-disabled","confirm-button-text","cancel-button-text"])])}}}),Ke=N(Ge,[["__scopeId","data-v-2c80ecdb"]]),re=i=>(be("data-v-702ffc39"),i=i(),xe(),i),Xe={class:"pre-process-setting"},qe={class:"canvas-container"},Je=re(()=>S("div",{class:"canvas-edit-bar"},"点击进入编辑/参数设置",-1)),Qe=re(()=>S("div",{style:{height:"100px"}},null,-1)),Ze=B({__name:"Index",props:{filePath:{default:""}},setup(i){const e=R(),n=_(),s=H(Z),h=H(ce),p=i;V(()=>s.uiEffect.initFinish,c=>{c.value&&!K(p.filePath,".xcs")&&s.sendEvent(new ge(p.filePath,{offsetX:pe,offsetY:me}))}),F(()=>{const{filePath:c,fileId:t,fileName:l}=e.currentRoute.value.query;c&&K(c,".xcs")&&h.sendEvent(new ae({filePath:c.toString(),fileId:t==null?void 0:t.toString(),fileName:l==null?void 0:l.toString()}))}),Q(()=>(e.back(),!0)),L(()=>s.uiState.htmlCanvas,c=>{var l,d,f,m;if(!c)return;const t=c.canvas;if(t&&n.value){(l=n.value)!=null&&l.innerHTML&&(n.value.innerHTML=""),(d=n.value)==null||d.appendChild(t);const{width:b,height:a}=he(t.width/2,t.height/2,((f=n.value)==null?void 0:f.clientWidth)??0,((m=n.value)==null?void 0:m.clientHeight)??0);t.style.width=`${b}px`,t.style.height=`${a}px`}});const v=_([]);V(()=>s.uiState.cnvIdentities,c=>{c&&c.forEach(t=>{v.value.push(t)})});const M=async()=>{await e.push("/process")};return fe((c,t,l)=>{c.path==="/"&&A().clear(),l()}),(c,t)=>{const l=Pe("router-link"),d=Te,f=ne;return P(),$("div",Xe,[u(Ke),u(Ye),S("div",qe,[u(l,{class:"canvas-image",to:"/editor"},{default:g(()=>[Je,S("div",{ref_key:"canvasPreviewWrapper",ref:n,class:"canvas-container-box"},null,512)]),_:1}),Qe]),u(f,{direction:"vertical",class:"start-button-wrapper"},{default:g(()=>[u(d,{class:"start-button",type:"success",onClick:M},{default:g(()=>[Me(" 开始加工 ")]),_:1})]),_:1})])}}}),ut=N(Ze,[["__scopeId","data-v-702ffc39"]]);export{ut as default};
