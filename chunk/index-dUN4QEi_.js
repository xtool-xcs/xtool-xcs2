import{useExtCenterStore as f,useViewModel as q,observeEffect as h,useDataSource as J,ExtManager as w,getPlatform as Q,useFirmwareUpdateStore as Y,useSettingStore as Z,ProductType as $,xcsApp as r,useCanvasStore as ee,isEmpty as oe,deviceManager as S,useProcessStore as te,ADD_EXT_MODE as ne,_export_sfc as se}from"./main-f7BGirYr.js";import{useI18n as ae}from"./importmap-vue-i18n-LlhaB8iP.js";import"../assets/index-FfF0Lcw0.js";import{useMessage as ce}from"./usemessage-BSDaXe4E.js";import{GetHotspotInfoEvent as ie,GetWifiInfoEvent as re,HotspotConfigViewModel as de,MODE_DEVICE_CONNECT as v}from"./hotspotconfigviewmodel-8JYLNcii.js";import{useRouter as le}from"./importmap-vue-router-aHGpzyJi.js";import{defineComponent as ue,watch as me,ref as g,computed as d,onMounted as pe,onUnmounted as fe,openBlock as E,createBlock as C,withCtx as we,createBaseVNode as he,resolveDynamicComponent as ve,mergeProps as ge,unref as Ie}from"./importmap-vue-u6Q_1Jji.js";import{Space as _e,showConfirmDialog as xe}from"./importmap-vant-Ij4SMMwJ.js";const Se=ue({__name:"Index",setup(Ee){const p=le(),{t:s}=ae(),o=f(),a=q(de);h(()=>a.uiEffect.showToast,e=>{r.modal.showToast({icon:"info",msg:s(e.msgKey),wordBreak:"break-word"})}),h(()=>a.uiEffect.showSuccessToast,e=>{r.modal.showToast({icon:"success",msg:s(e.msgKey),wordBreak:"break-word"})}),h(()=>a.uiEffect.showFailToast,e=>{r.modal.showToast({icon:"error",msg:s(e.msgKey),wordBreak:"break-word"})}),me(()=>f().connected,e=>{e||p.go(-1)});const y=g(0),k=d(()=>o.isInProcessing),D=d(()=>o.ext),I=d(()=>o.connected),{deviceValues:U}=J(),l=g(!1),u=g(!1);pe(async()=>{try{a.sendEvent(new ie),a.sendEvent(new re),console.log("更新设备信息"),o.updateDeviceInfo(),console.log("检查是否有ext插件版本需要更新");const e=o.extId;if(l.value=w.updateInfo[e].shouldUpdate||!1,u.value=w.updateInfo[e].hasUpdate||!1,!o.isAutoUpdateDeviceExt()&&!u.value){const t=await window.MeApi.app.getAppVersion(),n=o.currentInstanceId;w.checkShouldUpdate({instanceId:n,platformVersion:t,platform:Q()}).then(c=>{l.value=c})}}catch(e){console.log("[更新设备信息/检查插件更新异常]=>",e)}});const A=Y(),B=async()=>{if(console.log("[固件更新检查checkUpdateFirmware]"),!I.value){r.modal.showToast({msg:s("device.status.please_connect_device"),wordBreak:"break-word"});return}try{await A.checkUpdateFirmware(f().ext,!0)||r.modal.showToast({icon:"info",msg:s("device.firmware.latest_firmware"),wordBreak:"break-word"})}catch(e){console.log("[固件更新失败]=>",e),r.modal.showToast({icon:"error",msg:s("setting.check_update_fail"),wordBreak:"break-word"})}},M=e=>{console.log(e),o.updateDeviceSettingInfo(e)},N=async e=>{var n;const{ext:t}=o;if(oe(e.trim())){r.modal.showToast({icon:"info",msg:s("device.setting.name_is_empty")});return}await((n=t==null?void 0:t.apis)==null?void 0:n.setDeviceName({data:{deviceName:e}})),M({name:e})};let T=d(()=>a.uiState.cur_mode===v.AP?a.uiState.hotspotName:""),P=d(()=>a.uiState.hotspotPassword),b=d(()=>a.uiState.cur_mode),V=d(()=>a.uiState.cur_mode===v.AP?a.uiState.wifiName.length>0?1:0:-1);const F=e=>{xe({title:s("mobile.connect.modify_device_name"),message:s("mobile.connect.modify_device_name_dialog_tip"),confirmButtonText:s("mobile.common.confirm"),cancelButtonText:s("mobile.common.cancel"),className:"hotspot-custom-confirm-dialog",closeOnClickOverlay:!1}).then(async()=>{e(!0)}).catch(()=>{e(!1)})},K=()=>{S.closeConnect(S.currentInstanceId)},G=async()=>{await te().exportGCodeFile(o.currentInstanceId)},H=()=>{},O=async(e,t,n)=>{const c=o.currentInstanceId;await o.uploadExt({extId:e,instanceId:c,createBy:ne.MANUAL,callback:n}),u.value=w.updateInfo[e].hasUpdate||!1},_=()=>{console.log("=====extCenterStore.info",o.info);const e=f().checkDeviceIsIdle();return console.log("=====IDLE",e),a.uiState.cur_mode===v.AP&&!e?(r.modal.showToast({msg:s("device.process.device_is_working"),wordBreak:"break-word"}),!1):!0},W=()=>{_()&&p.push("/configWifiByHotspot")},L=()=>{_()&&p.push("/modifyHotspotPwd")},R=()=>{},z=()=>{},X=()=>{var t;const{ext:e}=o;(t=e==null?void 0:e.uiApp)==null||t.goToCheckStep(p,e)},j=Z(),x=d(()=>{const{ext:e,info:t}=o;if(!e)return{};const n=o.isAutoUpdateDeviceExt(),c=ee().canvasId;return{componentIs:e.uiApp.DeviceSetting,props:{show:!1,loading:!1,unit:j.unit,ext:e,canvasId:c,info:{...t,isInProcessing:k,wifiConnect:o.connected,showRedDot:!n&&l.value,hasNewExtVersion:!n&&l.value,hasUpdatedExtVersion:u.value,showUploadExtButton:l.value&&!u.value&&!n,hotspotMode:b.value,hotspotName:T.value,hotspotPwd:P.value,hotspotConnectAndConfig:V.value},hotspot:{},checkUpdateFirmware:B,setDeviceName:N,modifyDeviceName:F,closeConnect:K,exportGcode:G,updateExt:O,onClose:H,onShowWifiConfig:W,onShowModifyHotspotPwd:L,onShowConnector:R,onShowUploadGcode:z,onShowExtendCalibration:X}}});let i;return o.extId===$.F1Ultra&&ce("device.status.taking_picture",e=>{var t,n,c,m;i||(i=r.modal.showToast({icon:"info",duration:0,msg:((t=e.message)==null?void 0:t.contentI18nKey)||"",params:(n=e.message)==null?void 0:n.contentI18nArgs})),e.isDestroy?(i==null||i.close(),i=void 0):i.message=s(((c=e.message)==null?void 0:c.contentI18nKey)||"",((m=e.message)==null?void 0:m.contentI18nArgs)||"")}),fe(()=>{i==null||i.close()}),(e,t)=>{const n=_e;return E(),C(n,{direction:"vertical",size:8,class:"device-setting-wrap"},{default:we(()=>{var c,m;return[he("section",null,[(E(),C(ve((c=x.value)==null?void 0:c.componentIs),ge({id:y.value},(m=x.value)==null?void 0:m.props,{ext:D.value,connected:I.value,"device-values":Ie(U)}),null,16,["id","ext","connected","device-values"]))])]}),_:1})}}}),Ne=se(Se,[["__scopeId","data-v-0f8fda2e"]]);export{Ne as default};
